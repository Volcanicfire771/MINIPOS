@model IEnumerable<POSSystemMVC.Models.Product>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div style="display:flex;justify-content:space-between;">
    <h2>All Products</h2>
    <a class="btn btn-primary" asp-action="Create">Create Product</a>
</div>

<input type="text" placeholder="Search" id="myInput" onkeyup="tableSearch()" />
<table class="table">
    <thead>
        <tr>
            @* <th>Product Name</th> *@
            <th>Code</th>
            <th>Price</th>
            <th>Description</th>
            <th style="text-align:center;">Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var product in Model)
        {
            <tr id="row-@product.ProductID">
                <!-- Display Mode -->
                <td class="view-mode">
                    <span>@product.code</span>
                </td>
                <td class="view-mode">
                    <span>@product.CostPrice.ToString("C")</span>
                </td>
                <td class="view-mode">
                    <span>@product.Description</span>
                </td>
                
                <!-- Edit Mode (hidden initially) -->
                <td class="edit-mode" style="display:none">
                    <input type="text" value="@product.code" class="form-control" />
                </td>
                <td class="edit-mode" style="display:none">
                    <input type="number" value="@product.CostPrice" class="form-control" />
                </td>
                <td class="edit-mode" style="display:none">
                    <input type="text" value="@product.Description" class="form-control" />
                </td>
                
                <td style="text-align:center;">
                    <!-- Edit/Save Button -->
                    <button class="btn btn-sm btn-primary edit-btn"
                            data-id="@product.ProductID"
                            onclick="toggleEditMode(@product.ProductID)">
                        Edit
                    </button>                    <a asp-action="Delete" asp-route-id="@product.ProductID" class="btn btn-sm btn-danger">Delete</a>


                    <!-- Details Button -->
                    <button class="btn btn-sm btn-info details-btn" data-id="@product.ProductID">
                        Details
                    </button>
                    
                   >
                </td>
            </tr>
        }
    </tbody>
</table>

<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Product Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Details will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script>
    function toggleEditMode(productId) {
        console.log("Edit clicked for product:", productId); // Debug
        var row = $('#row-' + productId);
        var isEditing = row.find('.edit-mode').is(':visible');

        if (isEditing) {
            saveProduct(productId);
        } else {
            row.find('.view-mode').hide();
            row.find('.edit-mode').show();
            row.find('.edit-btn').text('Save').removeClass('btn-primary').addClass('btn-success');
        }
    }

        function saveProduct(productId) {
        console.log("Saving product:", productId); // Debug - REMOVE @* *@
        var row = $('#row-' + productId);
        var productData = {
            ProductID: productId,
            Code: row.find('.edit-mode:eq(0) input').val(),
            CostPrice: parseFloat(row.find('.edit-mode:eq(1) input').val()),
            Description: row.find('.edit-mode:eq(2) input').val() || ""
        };

        console.log('Data:', productData);
        console.log('Code:', productData.Code);

        // Check for duplicates
        let spans = document.getElementsByClassName("view-mode");
        let isDuplicate = false;

        for(let i = 0; i < spans.length; i++) {
            // Get the code from each row's first view-mode span
            let existingCode = spans[i].querySelector('span')?.textContent;

            if (existingCode && existingCode === productData.Code) {
                // Check if it's not the same product we're editing
                let rowId = spans[i].closest('tr').id.replace('row-', '');
                if (rowId != productId) { // Only alert if different product
                    alert("The same code already exists for another product.");
                    isDuplicate = true;
                    break;
                }
            }
        }

        if (isDuplicate) {
            return; // Stop the save operation
        }

        $.ajax({
            url: '@Url.Action("UpdateProduct", "Products")',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(productData),
            success: function() {
                row.find('.view-mode:eq(0) span').text(productData.Code);
                row.find('.view-mode:eq(1) span').text('$' + productData.CostPrice);
                row.find('.view-mode:eq(2) span').text(productData.Description);

                row.find('.edit-mode').hide();
                row.find('.view-mode').show();
                row.find('.edit-btn').text('Edit').removeClass('btn-success').addClass('btn-primary');

                alert('Product updated successfully!');
            },
            error: function(xhr, status, error) {
                console.log('Error:', error, xhr.responseText);
                alert('Error updating product');
            }
        });
    }

function tableSearch(){
       let input, table, filter, tr, td, i, txtValue;

       //initializing variables
       input = document.getElementById("myInput");
       filter = input.value.toUpperCase();
       table = document.getElementsByClassName("table")[0];
       tr = table.getElementsByTagName("tr");

           
       for(let i = 0; i < tr.length; i++){
           td = tr[i].getElementsByTagName("td")[0];
           @* console.log(td); *@
           if(td){
               txtValue = td.textContent || td.innerText;
               if(txtValue.toUpperCase().indexOf(filter) > -1){
                   tr[i].style.display = ""
               }
               else{
                   tr[i].style.display = "none"

               }
           }
       }

}


</script>

<script>
    // Bootstrap version
    document.querySelectorAll('.details-btn').forEach(button => {
        button.addEventListener('click', function() {
            var productId = this.getAttribute('data-id');
            showProductDetails(productId);
        });
    });

    function showProductDetails(productId) {
        var row = document.getElementById('row-' + productId);

        if (row) {
            var cells = row.getElementsByTagName('td');
            var detailsHtml = `

                <div class="detail-item">
                    <strong>Product ID:</strong> ${productId}
                </div>

                <div class="detail-item">
                    <strong>Code:</strong> ${cells[0].querySelector('span').textContent}
                </div>
                <div class="detail-item">
                    <strong>Price:</strong> ${cells[1].querySelector('span').textContent}
                </div>
                <div class="detail-item">
                    <strong>Description:</strong> ${cells[2].querySelector('span').textContent}
                </div>
                
            `;

            document.getElementById('modalBody').innerHTML = detailsHtml;

            // Show Bootstrap modal
            var modal = new bootstrap.Modal(document.getElementById('detailsModal'));
            modal.show();
        }
    }
</script>
@* <a href="/Home/Index" class="btn btn-secondary">Back to Home</a> *@